<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>阶段三 · 社会认知与调节</title>
<style>
  :root{--bg:#0b1020;--panel:#0f1530;--line:#2a3561;--text:#e9edff;--muted:#aab4ff;--ok:#27c17d;--bad:#ff5d6a;--brand:#5b8cff;--r:18px}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1126);color:var(--text);font-family:-apple-system,system-ui,"PingFang SC","Noto Sans SC",Arial}
  .app{min-height:100%;display:grid;grid-template-rows:auto 1fr auto;max-width:520px;margin:0 auto}
  header{position:sticky;top:0;background:rgba(15,21,48,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20}
  .bar{display:flex;align-items:center;gap:10px;padding:10px 14px}
  .bar h1{font-size:18px;margin:0;font-weight:800}
  .bar .act{margin-left:auto;display:flex;gap:8px}
  .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#151d42;color:var(--text);border-radius:14px;padding:10px 14px;font-weight:700;min-height:44px;min-width:44px;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  .btn.primary{background:linear-gradient(90deg,var(--brand),#73a4ff);border-color:transparent;color:#fff}
  .btn.ghost{background:transparent}
  .btn:active{transform:scale(.98)}
  main{padding:12px}
  .sec{background:linear-gradient(160deg,var(--panel),#0d1330);border:1px solid var(--line);border-radius:var(--r);padding:12px;margin-bottom:12px}
  .sec h2{font-size:16px;margin:0 0 8px 0}
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  .tile{display:flex;align-items:center;gap:10px;background:linear-gradient(160deg,#121a3a,#0e1533);border:1px solid var(--line);border-radius:14px;padding:12px}
  .tile .ico{font-size:24px}
  .tile .meta{margin-left:auto;color:var(--muted);font-size:12px}
  .hero{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .hero .ico{font-size:22px}
  .card{background:linear-gradient(160deg,#11183a,#0d1330);border:1px solid var(--line);border-radius:16px;padding:12px}
  .choices{display:grid;grid-template-columns:1fr;gap:10px}
  .choice{border:2px solid var(--line);border-radius:14px;background:#151d42;color:var(--text);min-height:64px;font-size:18px;font-weight:700}
  .choice.good{border-color:var(--ok);background:linear-gradient(180deg,#10271f,#0e1f19)}
  .choice.bad{border-color:var(--bad);background:linear-gradient(180deg,#2a1620,#1c0f14)}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#1b234a;color:var(--muted);font-size:12px}
  .coach{border:2px dashed var(--line);border-radius:14px;padding:10px;color:var(--muted)}
  footer{padding:8px 14px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="bar">
      <h1>👥 阶段三 · 社会认知与调节</h1>
      <div class="act">
        <button class="btn" id="btnHome">🏠</button>
        <button class="btn" id="btnReport">📈</button>
        <button class="btn" id="btnExport">🧾</button>
      </div>
    </div>
  </header>
  <main id="main" tabindex="-1" aria-live="polite"></main>
  <footer>© <span id="y"></span> 情绪训练 · 阶段三 · 本地运行 / iPad 触控优化</footer>
</div>
<script>
(function(){
  const $=(s,el=document)=>el.querySelector(s);
  const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
  const DB_KEY='emo.stage3.v1';
  const state={score:{}, prefs:{speech:true}};
  const speak=(t)=>{ if(!state.prefs.speech) return; try{const u=new SpeechSynthesisUtterance(t);u.lang='zh-CN';speechSynthesis.cancel();speechSynthesis.speak(u);}catch(e){} };
  const save=()=>localStorage.setItem(DB_KEY,JSON.stringify(state));
  const load=()=>{try{const raw=localStorage.getItem(DB_KEY); if(raw) Object.assign(state, JSON.parse(raw));}catch(e){} };
  const bump=(gid,ok)=>{ const s=state.score[gid]||(state.score[gid]={ok:0,ng:0,best:0,last:''}); if(ok) s.ok++; else s.ng++; s.best=Math.max(s.best,s.ok); s.last=new Date().toLocaleString(); save(); };
  const csv=()=>{ const rows=[["game","ok","ng","best","last"]]; Object.entries(state.score).forEach(([g,s])=>rows.push([g,s.ok||0,s.ng||0,s.best||0,s.last||''])); return rows.map(r=>r.join('\n')).join('\n'); };
  const download=(name,content)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:'text/plain;charset=utf-8;'})); a.download=name; a.click(); URL.revokeObjectURL(a.href); };

  function home(){
    const items=[
      {id:'g7',hash:'#g7',ico:'🧭',name:'(7) 社会情境决策'},
      {id:'g8',hash:'#g8',ico:'💨',name:'(8) 情绪调节策略'},
      {id:'g9',hash:'#g9',ico:'🤝',name:'(9) 共情理解'}
    ];
    $('#main').innerHTML=`<section class='sec'><h2>选择一个小游戏开始</h2><div class='grid'>${items.map(x=>`<button class='tile' onclick=\"location.hash='${x.hash}'\"><div class='ico'>${x.ico}</div><div>${x.name}</div><div class='meta'>最佳 ${(state.score[x.id]?.best)||0}</div></button>`).join('')}</div><div class='row' style='margin-top:8px'><span class='chip'>语音播报已${state.prefs.speech?'开启':'关闭'}</span><button class='btn' id='toggleSpeech'>🔊 切换语音</button></div></section>`;
    $('#toggleSpeech').onclick=()=>{state.prefs.speech=!state.prefs.speech; save(); home();};
    speak('请选择一个训练开始。');
  }

  function report(){
    const list=Object.entries(state.score);
    $('#main').innerHTML=`<section class='sec'><div class='hero'><div class='ico'>📈</div><h2>学习报告</h2></div><div class='card'><table style='width:100%;border-collapse:collapse;font-size:14px'><thead><tr><th style='text-align:left;padding:6px;border-bottom:1px solid var(--line)'>游戏</th><th style='text-align:right;padding:6px;border-bottom:1px solid var(--line)'>✅</th><th style='text-align:right;padding:6px;border-bottom:1px solid var(--line)'>❌</th><th style='text-align:right;padding:6px;border-bottom:1px solid var(--line)'>🏆</th><th style='text-align:right;padding:6px;border-bottom:1px solid var(--line)'>最近</th></tr></thead><tbody>${list.map(([g,s])=>`<tr><td style='padding:6px;border-bottom:1px dashed var(--line)'>${g}</td><td style='padding:6px;text-align:right;border-bottom:1px dashed var(--line)'>${s.ok||0}</td><td style='padding:6px;text-align:right;border-bottom:1px dashed var(--line)'>${s.ng||0}</td><td style='padding:6px;text-align:right;border-bottom:1px dashed var(--line)'>${s.best||0}</td><td style='padding:6px;text-align:right;border-bottom:1px dashed var(--line)'>${s.last||'—'}</td></tr>`).join('')}</tbody></table></div><div class='row' style='margin-top:8px'><span class='chip'>本地保存 · 可导出 CSV</span><button class='btn primary' id='back'>返回主页</button></div></section>`;
    $('#back').onclick=()=>{location.hash='#home'}
  }

  // ======== g7 社会情境决策 ========
  function g7(){
    const bank=[
      {s:'排队时有人插队', opts:[
        {t:'大声骂他', ok:false, why:'会引发冲突，不安全。'},
        {t:'默默生气', ok:false, why:'问题没有解决。'},
        {t:'告诉老师/家长', ok:true,  why:'寻求大人帮助是安全且合适的方式。'},
        {t:'也去插别人的队', ok:false, why:'以牙还牙会让问题更糟。'}]},
      {s:'同学借了你的笔没还', opts:[
        {t:'直接抢回来', ok:false, why:'不礼貌且可能伤人。'},
        {t:'礼貌提醒对方', ok:true,  why:'用合适语言表达诉求最恰当。'},
        {t:'把对方东西藏起来', ok:false, why:'报复行为不合适。'},
        {t:'一直忍着不说', ok:false, why:'情绪会积累，问题仍在。'}]},
      {s:'有人在教室里大声喧哗', opts:[
        {t:'加入一起吵闹', ok:false, why:'会影响他人和课堂秩序。'},
        {t:'捂住耳朵并离开到安静角落', ok:true,  why:'先自我调节，保护自己。'},
        {t:'推开对方', ok:false, why:'有安全风险。'},
        {t:'生闷气不说话', ok:false, why:'无法改变现状。'}]}
    ];
    const s=state.score.g7||{}; const q=bank[Math.floor(Math.random()*bank.length)];
    $('#main').innerHTML=`<section class='sec'><div class='hero'><div class='ico'>👥</div><h2>(7) 社会情境决策</h2></div><div class='card'><p class='chip'>情境：${q.s}</p><div class='choices'>${q.opts.map((o,i)=>`<button class='choice' data-i='${i}'>${o.t}</button>`).join('')}</div><div class='coach' id='coach'>请选择最合适的做法。</div><div class='row' style='margin-top:8px'><span class='chip'>✅ ${(s.ok||0)}　❌ ${(s.ng||0)}　🏆 ${(s.best||0)}</span><button class='btn primary' id='next'>下一题</button></div></div></section>`;
    const coach=$('#coach');
    $$('.choice').forEach(b=> b.onclick=()=>{ const o=q.opts[+b.dataset.i]; const ok=o.ok; b.classList.add(ok?'good':'bad'); bump('g7',ok); coach.textContent=(ok?'✅ 做得好！ ':'❌ 再想想。 ')+o.why; speak(ok?'你真棒！':'再想想'); });
    $('#next').onclick=()=>g7();
  }

  // ======== g8 情绪调节策略 ========
  function g8(){
    $('#main').innerHTML=`<section class='sec'><div class='hero'><div class='ico'>💨</div><h2>(8) 情绪调节策略</h2></div><div class='card'><p class='chip'>我现在很生气/紧张，我可以……</p><div class='choices' id='strats'><button class='choice' data-act='breath'>💨 深呼吸5次</button><button class='choice' data-act='count'>🔢 从1数到10</button><button class='choice' data-act='adult'>👥 找大人帮忙</button><button class='choice' data-act='draw'>🎨 画画表达</button></div><div class='coach' id='coach'>选择一个策略，系统会给分步指导。</div><div class='row' style='margin-top:8px'><span class='chip'>✅ ${(state.score.g8?.ok||0)}　❌ ${(state.score.g8?.ng||0)}　🏆 ${(state.score.g8?.best||0)}</span><button class='btn primary' id='done'>我完成了</button></div></div></section>`;
    const coach=$('#coach'); let started=false;
    $('#strats').onclick=(e)=>{
      const b=e.target.closest('.choice'); if(!b) return; started=true; const act=b.dataset.act; bump('g8',true);
      if(act==='breath'){ coach.innerHTML='<b>练习：深呼吸</b><ol><li>吸气 4 秒</li><li>停 2 秒</li><li>呼气 4 秒</li><li>重复 5 次</li></ol>'; speak('吸四秒，停两秒，呼四秒，一共五次。'); }
      if(act==='count'){ coach.innerHTML='<b>练习：数数</b><p>慢慢从 1 数到 10，配合均匀呼吸。</p>'; speak('慢慢从一数到十。'); }
      if(act==='adult'){ coach.innerHTML='<b>求助：找大人</b><p>请找到老师或家长，清楚说出发生了什么和你的感受。</p>'; speak('去找大人帮忙，把发生的事情和你的感受说清楚。'); }
      if(act==='draw'){ coach.innerHTML='<b>表达：画画</b><p>拿纸笔把你的感受画出来，完成后给老师看。</p>'; speak('拿起纸笔，把你的感受画出来。'); }
    };
    $('#done').onclick=()=>{ if(!started){ speak('先选择一个策略'); return;} speak('做得好！'); };
  }

  // ======== g9 共情理解 ========
  function g9(){
    const bank=[
      {story:'小美精心准备的画被同学不小心弄脏了。', ask:'小美现在感觉怎么样？', opts:[
        {t:'高兴', ok:false, why:'画被弄脏通常不会高兴。'},
        {t:'伤心', ok:true,  why:'付出心血被破坏，人会感到难过。'},
        {t:'饥饿', ok:false, why:'与情境不相关。'}]},
      {story:'小强在操场上被人推了一把。', ask:'他更可能的感受？', opts:[
        {t:'生气', ok:true,  why:'被推挤会生气。'},
        {t:'开心', ok:false, why:'被冒犯一般不会开心。'},
        {t:'困倦', ok:false, why:'与情境无关。'}]},
      {story:'妈妈提前来接我，并带了我最喜欢的点心。', ask:'我更可能的感受？', opts:[
        {t:'害怕', ok:false, why:'没有危险线索。'},
        {t:'高兴', ok:true,  why:'被关心和被奖励通常会高兴。'},
        {t:'难过', ok:false, why:'与情境不符。'}]}
    ];
    const s=state.score.g9||{}; const q=bank[Math.floor(Math.random()*bank.length)];
    $('#main').innerHTML=`<section class='sec'><div class='hero'><div class='ico'>🤝</div><h2>(9) 共情理解</h2></div><div class='card'><p class='chip'>想一想：如果是你会怎样？</p><h3 style='margin:8px 0'>${q.story}</h3><p style='color:var(--muted)'>${q.ask}</p><div class='choices'>${q.opts.map((o,i)=>`<button class='choice' data-i='${i}'>${o.t}</button>`).join('')}</div><div class='coach' id='coach'>选择你认为最合适的答案。</div><div class='row' style='margin-top:8px'><span class='chip'>✅ ${(s.ok||0)}　❌ ${(s.ng||0)}　🏆 ${(s.best||0)}</span><button class='btn primary' id='next'>下一题</button></div></div></section>`;
    const coach=$('#coach');
    $$('.choice').forEach(b=> b.onclick=()=>{ const o=q.opts[+b.dataset.i]; const ok=o.ok; b.classList.add(ok?'good':'bad'); bump('g9',ok); coach.textContent=(ok?'✅ 正确！ ':'❌ 再想想。 ')+o.why; speak(ok?'你真棒！':'再想想'); });
    $('#next').onclick=()=>g9();
  }

  const routes={'#home':home,'':home,'#report':report,'#g7':g7,'#g8':g8,'#g9':g9};
  function router(){ (routes[location.hash]||home)(); window.scrollTo({top:0,behavior:'instant'}); }
  function bind(){
    $('#btnHome').onclick=()=>location.hash='#home';
    $('#btnReport').onclick=()=>location.hash='#report';
    $('#btnExport').onclick=()=>download('stage3_report.csv', csv());
  }
  load(); bind(); router(); window.addEventListener('hashchange',router); $('#y').textContent=new Date().getFullYear();
})();
</script>
</body>
</html>
